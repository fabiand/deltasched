<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>hello-wasm example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="assets/jquery-3.7.1.min.js"></script>
  </head>
  <body>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

<!-- wasm-pack build --target web -->
    <script type="module">

      function milestonesOf(sched, w) {
        let ms = []
        $(sched[w].phases).each(function() {
          $(this.milestones).each(function() {
            ms.push(this)
          })
        })
        return ms
      }

      function buildView(doc) {
        console.log("Bulding view")
        let sched = JSON.parse(doc.as_json_string())

        let view = $("#sched-view");

        $(sched.status.phases).each(function() {
          //console.log(`Building phase ${this.name}`);

          $(this.milestones).each(function() {
            console.log(`Building ms ${this.name}`);
            console.log(this)
            let row = $("<tr/>")
              .attr("id", this.alias)
              .attr("class", "ds-milestone");

            if (new RegExp("General|Feature").test(this.name)) {
              row.attr("class", $(row).attr("class") + " table-primary")
            }

            let cell_alias = $("<td/>").text(this.name)

            let input = $("<input>")
              .attr("type", "text")
              .attr("class", "form-control")
              .attr("pattern", "\\d{4}-\\d{1,2}-\\d{1,2}")
              .attr("placeholder", this.due_date);

            let weekday = $("<span/>")
              .attr("class", "input-group-text col-3 ds-weekday")
              .text("wkd");

            let remaining = $("<span/>")
              .attr("class", "input-group-text col-3 ds-remaining")
              .text("remaining");

            let inputgroup = $("<div/>")
              .attr("class", "input-group")
              .append(weekday)
              .append(input)
              .append(remaining)

            let cell_duedate = $("<td>")
              .append(inputgroup);

            row.append(cell_alias)
            row.append(cell_duedate)
            view.append(row);
          })
        });
      }

      function updateView(doc) {
        console.log("Updating view")

        let sched = JSON.parse(doc.as_json_string())
        console.log(sched)

        let ms = milestonesOf(sched, "status")
        $(ms).each(function() {
          console.log(`Display new due for ${this.alias} on ${this.due_date}`)
          $(`#${this.alias}`)
            .find("input").val(this.due_date);

          let wk = $(`#${this.alias}`).find("span.ds-weekday")
          let wkName = new Date(this.due_date).toLocaleDateString("en", { weekday: 'long' })
          wk.text(wkName)
          if (new RegExp("Thu|Fri|Sat|Sun").test(wkName)) {
            wk.addClass("text-bg-warning")
          } else {
            wk.removeClass("text-bg-warning")
          }

          let remainingDays = Math.round((new Date(this.due_date) - Date.now()) / (1000 * 3600 * 24))
          let remaining = "-"
          if (remainingDays > 0) { remaining = `${remainingDays} days remaining`; }
          $(`#${this.alias}`)
            .find("span.ds-remaining")
            .text(`${remaining}`)
        })
      }

      function connectView(doc) {
      console.log("Connecting â€¦")
      $("tr").each(function() {
        console.log("conn " + $(this).text())
        let ms_alias = $(this).find("td:first-of-type").text()
        $(this).find("input").change(function(evnt) {
          let due_date = $(evnt.target).val()
          console.log(`New due for ${ms_alias}: ${due_date}`)
          doc.update_and_replan(ms_alias, due_date)
          updateView(doc)
        })
      })
      }


      function addReleasesView(releases) {
        let grp = $("<div/>")
          .attr("class", "btn-group")
          .attr("role", "group");

        $(releases.streams).each(function () {
          console.log("Found stream: " + this.file)
          let btn = $("<button/>")
            .attr("type", "button")
            .attr("class", "btn btn-primary")
            .text(this.file)

          let stFile = this.file
          btn.on("click", function(tgt) {
            newReleaseSelected(stFile);
            // FIXME this can for sure be done better
            btn.parent().find("button").each(function () { $(this).removeClass("active")})
            btn.button("toggle")
          });
          grp.append(btn)
        })

        $("#release-view").append(grp)
      }

      fetch('./schedule/streams.json')
          .then((response) => response.json())
          .then((json) => addReleasesView(json));

      function newReleaseSelected(relFile) {
      	const doc = new WasmSched()
        fetch(`./schedule/${relFile}`, {cache: "no-store"})
            .then((response) => response.text())
            .then((yml) => {
                console.log("NEW RELEASE")
                console.log(yml)
                doc.from_yaml(yml)
                doc.replan();
                buildView(doc);
                updateView(doc);
                connectView(doc);
        })
      }

      import init, { WasmSched } from "./pkg/deltasched.js";
      init().then(() => {
        //newReleaseSelected("4.17.yaml")
      });
    </script>

    <div class="container">
      <div class="row">
        <div class="col p-4" id="release-view"/>
      </div>
      <div class="row">
        <form class="needs-validation">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Phase</th>
                <th>Due Date</th>
              </tr>
             </thead>
            <tbody id="sched-view">
            </tbody>
          </table>
        </form>
      </div>
    </div>
  </body>
</html>

