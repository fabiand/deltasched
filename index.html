<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>hello-wasm example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="assets/jquery-3.7.1.min.js"></script>
  </head>
  <body>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

<!-- wasm-pack build --target web -->
    <script type="module">

      function milestonesOf(sched) {
        let ms = []
        $(sched.status.phases).each(function() {
          $(this.milestones).each(function() {
            ms.push(this)
          })
        })
        return ms
      }

      function buildView(doc) {
        console.log("Bulding view")
        let sched = JSON.parse(doc.as_json_string())

        let view = $("#sched-view");

        $(sched.status.phases).each(function() {
          //console.log(`Building phase ${this.name}`);

          $(this.milestones).each(function() {
            if (/^z/.test(this.name)) { return }

            //console.log(`Building ms ${this.name}`);
            let row = $("<tr/>").attr("id", this.alias)
            let cell_alias = $("<td/>").text(this.name)

            let input = $("<input>")
              .attr("type", "text")
              .attr("class", "form-control")
              .attr("pattern", "\\d{4}-\\d{1,2}-\\d{1,2}")
              .attr("placeholder", this.due_date);

            let ms = this
            input.change(function(evnt) {
              let due_date = $(evnt.target).val()
              console.log(`New due for ${ms.alias}: ${due_date}`)
              doc.update_and_replan(ms.alias, due_date)
              updateView(doc)
            })

            let weekday = $("<span/>")
              .attr("class", "input-group-text col-3")
              .text("wkd");

            let inputgroup = $("<div/>")
              .attr("class", "input-group")
              .append(weekday)
              .append(input)

            let cell_duedate = $("<td>")
              .append(inputgroup);

            row.append(cell_alias)
            row.append(cell_duedate)
            view.append(row);
          })
        });

      }

      function updateView(doc) {
        console.log("Updating view")
        let sched = JSON.parse(doc.as_json_string())
        console.log(sched)
//        $("#dst").text(JSON.stringify(sched, undefined, 2))

        let ms = milestonesOf(sched)
        $(ms).each(function() {
          if (/^z/.test(this.name)) { return }

          console.log(`Display new due for ${this.alias} on ${this.due_date}`)
          $(`#${this.alias}`)
            .find("input").val(this.due_date);
          $(`#${this.alias}`)
            .find("span").text(new Date(this.due_date).toLocaleDateString("en", { weekday: 'long' }))
        })
      }

      import init, { WasmSched } from "./pkg/deltasched.js";
      init().then(() => {
      	const doc = new WasmSched()
        doc.replan();
        buildView(doc);
        updateView(doc);
      });
    </script>

    <div class="container">
    <div class="row">
    <form class="needs-validation">
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Phase</th>
          <th>Due Date</th>
        </tr>
       </thead>
      <tbody id="sched-view">
      </tbody>
    </table>
    </form>
    </div>
    </div>

<hr />

    <pre id="dst">
    </pre>
  </body>
</html>

